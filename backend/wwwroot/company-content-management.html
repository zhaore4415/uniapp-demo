<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公司内容管理 - 后台管理系统</title>
    <link rel="stylesheet" href="/common/common.css">
    <style>
        /* 页面特定样式 */
        /* 内容卡片 */
        .content-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .content-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .content-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .content-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .content-card-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .content-card-actions {
            display: flex;
            gap: 5px;
        }

        .content-card-body {
            margin-bottom: 15px;
        }

        .content-preview {
            color: #718096;
            font-size: 14px;
            line-height: 1.5;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .content-card-footer {
            font-size: 12px;
            color: #a0aec0;
            display: flex;
            justify-content: space-between;
        }

        /* 编辑器区域 */
        .editor-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .editor-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-textarea {
            min-height: 300px;
            resize: vertical;
            font-family: inherit;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .content-cards {
                grid-template-columns: 1fr;
            }
        }

        /* 提示框样式 */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.5;
            border: 1px solid transparent;
        }

        .alert-info {
            background-color: #e8f4fd;
            color: #1a73e8;
            border: 1px solid #bfe1ff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .alert h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #004085;
            font-size: 16px;
            font-weight: 600;
        }

        .alert ul {
            margin-top: 10px;
            margin-bottom: 15px;
            padding-left: 20px;
        }

        .alert li {
            margin-bottom: 5px;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- 主内容区域 -->
    <main class="main-content">
        <!-- 顶部导航栏 -->
        <nav class="top-navbar">
            <h2 class="page-title">公司内容管理</h2>
            <div class="user-profile">
                <div class="user-avatar">管</div>
                <div class="user-info">
                    <span class="user-name">系统管理员</span>
                    <span class="user-role">Admin</span>
                </div>
            </div>
        </nav>
        
        <!-- 权限问题诊断提示 -->
        <div class="alert alert-info mb-4">
            <h4>权限问题诊断</h4>
            <p>如果您遇到401 Unauthorized错误，请：</p>
            <ul>
                <li>确保使用管理员账户登录：admin@example.com / Admin@123</li>
                <li>点击下方按钮查看详细的token诊断信息</li>
            </ul>
        </div>
        <!-- 测试按钮 -->
        <div style="margin-bottom: 20px;">
            <button id="test-api-button" class="btn btn-secondary">测试API调用并查看token诊断</button>
        </div>

        <!-- 内容卡片列表 -->
        <div class="content-cards" id="content-cards">
            <!-- 内容卡片将通过JavaScript动态加载 -->
            <div style="text-align: center; color: #718096; padding: 40px; grid-column: 1 / -1;">
                正在加载数据...
            </div>
        </div>

        <!-- 编辑器区域 -->
        <div class="editor-section" id="editor-section">
            <div class="editor-header">
                <h3 class="editor-title" id="current-content-title">编辑内容</h3>
                <div class="editor-actions">
                    <button class="btn btn-secondary" id="cancel-edit">取消</button>
                    <button class="btn btn-danger" id="delete-content">删除</button>
                    <button class="btn btn-primary" id="save-content">保存</button>
                </div>
            </div>
            <form id="content-form">
                <input type="hidden" id="content-key">
                <div class="form-group">
                    <label class="form-label" for="content-title-input">标题</label>
                    <input type="text" class="form-input" id="content-title-input" placeholder="请输入页面标题" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="content-body">内容</label>
                    <textarea class="form-textarea" id="content-body" placeholder="请输入页面内容（支持HTML）" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="content-description">SEO描述</label>
                        <input type="text" class="form-input" id="content-description" placeholder="请输入SEO描述">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="content-keywords">SEO关键词</label>
                        <input type="text" class="form-input" id="content-keywords" placeholder="请输入SEO关键词，用逗号分隔">
                    </div>
                </div>
            </form>
        </div>
    </main>

    <script src="common/common.js"></script>
    <script>
        // 当前正在编辑的内容键
        let currentEditingKey = null;

        // 登录检查已移至公共JS中

        // 加载所有公司内容 - 这个端点是公开的，不需要认证
        async function loadCompanyContents() {
            console.log('开始加载公司内容...');
            try {
                // 使用完整的相对路径，确保请求正确发送
                console.log('请求URL:', '/api/companycontent');
                
                // 添加超时处理
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒超时
                
                const response = await fetch('/api/companycontent', {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId); // 清除超时定时器
                
                console.log('响应状态:', response.status);
                console.log('响应状态文本:', response.statusText);

                if (!response.ok) {
                    // 先读取响应体为文本，然后尝试解析为JSON
                    // 这样只读取一次响应体，避免"body stream already read"错误
                    const errorText = await response.text();
                    console.log('错误文本:', errorText);
                    
                    // 尝试将文本解析为JSON
                    try {
                        const errorData = JSON.parse(errorText);
                        console.log('错误数据(JSON):', errorData);
                        throw new Error(`加载内容失败: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                    } catch (e) {
                        // 如果不是有效的JSON，直接使用文本
                        throw new Error(`加载内容失败: ${response.status} ${response.statusText} - ${errorText}`);
                    }
                }

                const contents = await response.json();
                console.log('成功加载内容:', contents);
                renderContentCards(contents);
            } catch (error) {
                console.error('加载内容时发生错误:', error);
                console.error('错误详情:', error.stack);
                
                // 根据错误类型显示不同的提示
                let errorMessage = '加载数据失败，请刷新页面重试';
                if (error.name === 'AbortError') {
                    errorMessage = '请求超时，请检查网络连接';
                }
                
                document.getElementById('content-cards').innerHTML = `
                    <div style="text-align: center; color: #e53e3e; padding: 40px; grid-column: 1 / -1;">
                        ${errorMessage}
                    </div>
                `;
            }
        }

        // 渲染内容卡片列表
        function renderContentCards(contents) {
            const cardsContainer = document.getElementById('content-cards');
            if (contents.length === 0) {
                cardsContainer.innerHTML = `
                    <div style="text-align: center; color: #718096; padding: 40px; grid-column: 1 / -1;">
                        暂无内容，请添加新内容
                    </div>
                `;
                return;
            }

            cardsContainer.innerHTML = contents.map(item => `
                <div class="content-card" onclick="editContentByKeyInternal('${item.key}')">
                    <div class="content-card-header">
                        <h3 class="content-card-title">${item.title}</h3>
                        <div class="content-card-actions">
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="event.stopPropagation(); editContentByKeyInternal('${item.key}')">编辑</button>
                        </div>
                    </div>
                    <div class="content-card-body">
                        <div class="content-preview">${stripHtml(item.content)}</div>
                    </div>
                    <div class="content-card-footer">
                        <span>创建时间：${formatDate(item.createdAt)}</span>
                        <span>${item.updatedAt ? '已更新' : '未更新'}</span>
                    </div>
                </div>
            `).join('');
        }

        // 编辑特定内容（内部函数）
        async function editContentByKeyInternal(key) {
            try {
                // 同时检查localStorage和sessionStorage中的token，与common.js保持一致
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                
                // 准备请求选项
                const requestOptions = {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                // 只有在token存在时添加Authorization头
                if (token) {
                    requestOptions.headers['Authorization'] = `Bearer ${token}`;
                    console.log('已添加Authorization头');
                } else {
                    console.log('未添加Authorization头，因为token不存在');
                }
                
                // 使用完整的相对路径
                const response = await fetch(`/api/companycontent/${key}`, requestOptions);

                if (!response.ok) {
                    // 如果内容不存在，创建新内容
                    if (response.status === 404) {
                        showEditorForNewContent(key);
                        return;
                    }
                    throw new Error('获取内容失败');
                }

                const content = await response.json();
                showEditor(content);
            } catch (error) {
                console.error('Error:', error);
                alert('编辑内容失败');
            }
        }

        // 显示编辑器（编辑现有内容）
        function showEditor(content) {
            currentEditingKey = content.key;
            document.getElementById('current-content-title').textContent = `编辑：${content.title}`;
            document.getElementById('content-key').value = content.key;
            document.getElementById('content-title-input').value = content.title;
            document.getElementById('content-body').value = content.content;
            document.getElementById('content-description').value = content.description || '';
            document.getElementById('content-keywords').value = content.keywords || '';
            
            // 显示编辑器，隐藏卡片列表
            document.getElementById('content-cards').style.display = 'none';
            document.getElementById('editor-section').style.display = 'block';
            
            // 滚动到编辑器
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 显示编辑器（创建新内容）
        function showEditorForNewContent(key) {
            currentEditingKey = key;
            const keyToTitle = {
                'about': '关于我们',
                'contact': '联系我们',
                'privacy': '隐私政策',
                'terms': '服务条款'
            };
            
            const title = keyToTitle[key] || `新内容: ${key}`;
            
            document.getElementById('current-content-title').textContent = `创建：${title}`;
            document.getElementById('content-key').value = key;
            document.getElementById('content-title-input').value = title;
            document.getElementById('content-body').value = '';
            document.getElementById('content-description').value = '';
            document.getElementById('content-keywords').value = '';
            
            // 显示编辑器，隐藏卡片列表
            document.getElementById('content-cards').style.display = 'none';
            document.getElementById('editor-section').style.display = 'block';
            
            // 滚动到编辑器
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 保存内容
        async function saveContent() {
            const key = document.getElementById('content-key').value;
            const title = document.getElementById('content-title-input').value;
            const content = document.getElementById('content-body').value;
            const description = document.getElementById('content-description').value;
            const keywords = document.getElementById('content-keywords').value;

            if (!title || !content) {
                alert('请填写标题和内容');
                return;
            }

            try {
                // 详细记录token获取过程
                const localStorageToken = localStorage.getItem('token');
                const sessionStorageToken = sessionStorage.getItem('token');
                console.log('localStorage中的token:', localStorageToken ? '存在 (长度:' + localStorageToken.length + ')' : '不存在');
                console.log('sessionStorage中的token:', sessionStorageToken ? '存在 (长度:' + sessionStorageToken.length + ')' : '不存在');
                
                // 检查token格式
                if (localStorageToken) {
                    console.log('localStorage token前30个字符:', localStorageToken.substring(0, 30) + '...');
                }
                if (sessionStorageToken) {
                    console.log('sessionStorage token前30个字符:', sessionStorageToken.substring(0, 30) + '...');
                }
                
                // 同时检查localStorage和sessionStorage中的token，与common.js保持一致
                const token = localStorageToken || sessionStorageToken;
                console.log('最终使用的token:', token ? '已获取' : '未获取');
                if (!token) {
                    console.log('提示：请使用管理员账户登录（admin@example.com / Admin@123）');
                }
                
                const contentData = {
                    key,
                    title,
                    content,
                    description,
                    keywords
                };
                
                console.log('发送的数据:', contentData);
                console.log('请求URL:', `/api/companycontent/${key}`);
                
                // 准备请求选项
                const requestOptions = {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(contentData)
                };
                
                // 只有在token存在时添加Authorization头
                if (token) {
                    requestOptions.headers['Authorization'] = `Bearer ${token}`;
                    console.log('已添加Authorization头');
                } else {
                    console.log('未添加Authorization头，因为token不存在');
                }
                
                console.log('请求选项:', requestOptions);

                // 使用完整的相对路径
                const response = await fetch(`/api/companycontent/${key}`, requestOptions);

                if (!response.ok) {
                    console.log('响应状态:', response.status);
                    console.log('响应状态文本:', response.statusText);
                    // 尝试获取详细错误信息
                    const errorText = await response.text();
                    console.log('错误响应内容:', errorText);
                    throw new Error(`保存内容失败: ${response.status} ${response.statusText}. 详情: ${errorText}`);
                }

                // 隐藏编辑器，显示卡片列表
                document.getElementById('editor-section').style.display = 'none';
                document.getElementById('content-cards').style.display = 'grid';
                
                // 重新加载内容
                loadCompanyContents();
                alert('内容保存成功');
            } catch (error) {
                console.error('保存内容时发生错误:', error);
                console.error('错误详情:', error.stack);
                alert('保存内容失败: ' + error.message);
            }
        }
        
        // 测试API调用函数
        async function testApiCall() {
            console.log('开始测试API调用...');
            const testKey = 'about';
            
            try {
                // 详细记录token获取过程
                const localStorageToken = localStorage.getItem('token');
                const sessionStorageToken = sessionStorage.getItem('token');
                console.log('测试 - localStorage中的token:', localStorageToken ? '存在 (长度:' + localStorageToken.length + ')' : '不存在');
                console.log('测试 - sessionStorage中的token:', sessionStorageToken ? '存在 (长度:' + sessionStorageToken.length + ')' : '不存在');
                
                // 检查token格式
                if (localStorageToken) {
                    console.log('测试 - localStorage token前30个字符:', localStorageToken.substring(0, 30) + '...');
                }
                if (sessionStorageToken) {
                    console.log('测试 - sessionStorage token前30个字符:', sessionStorageToken.substring(0, 30) + '...');
                }
                
                const token = localStorageToken || sessionStorageToken;
                console.log('测试 - 使用的token:', token ? '已获取' : '未获取');
                
                // 准备请求选项
                const requestOptions = {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        key: testKey,
                        title: '测试标题',
                        content: '测试内容',
                        description: '测试描述',
                        keywords: '测试,关键词'
                    })
                };
                
                // 只有在token存在时添加Authorization头
                if (token) {
                    requestOptions.headers['Authorization'] = `Bearer ${token}`;
                    console.log('测试 - 已添加Authorization头，格式: Bearer [token]');
                } else {
                    console.log('测试 - 未添加Authorization头，因为token不存在');
                    console.log('测试 - 提示：请使用管理员账户登录（admin@example.com / Admin@123）');
                }
                
                console.log('测试 - 请求URL:', `/api/companycontent/${testKey}`);
                console.log('测试 - 请求选项(隐藏token):', {
                    method: requestOptions.method,
                    headers: {
                        'Content-Type': requestOptions.headers['Content-Type'],
                        'Authorization': requestOptions.headers['Authorization'] ? 'Bearer [token]' : '不存在'
                    },
                    body: 'JSON数据'
                });
                
                // 发送请求
                const response = await fetch(`/api/companycontent/${testKey}`, requestOptions);
                console.log('测试 - 响应状态:', response.status);
                console.log('测试 - 响应状态文本:', response.statusText);
                
                // 先读取响应体为文本，然后尝试解析为JSON
                // 这样只读取一次响应体，避免"body stream already read"错误
                const responseText = await response.text();
                console.log('测试 - 响应文本:', responseText);
                
                // 尝试将文本解析为JSON
                try {
                    const responseData = JSON.parse(responseText);
                    console.log('测试 - 响应数据(JSON):', responseData);
                } catch (e) {
                    console.log('测试 - 响应不是有效的JSON格式');
                }
                
                if (response.ok) {
                    alert('API调用测试成功!');
                } else {
                    alert(`API调用测试失败: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('测试API调用时发生错误:', error);
                console.error('测试错误详情:', error.stack);
                alert('测试失败: ' + error.message);
            }
        }

        // 删除内容
        async function deleteContent() {
            if (!currentEditingKey || !confirm('确定要删除此内容吗？此操作不可恢复！')) {
                return;
            }

            try {
                // 同时检查localStorage和sessionStorage中的token，与common.js保持一致
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                
                // 准备请求选项
                const requestOptions = {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                // 只有在token存在时添加Authorization头
                if (token) {
                    requestOptions.headers['Authorization'] = `Bearer ${token}`;
                    console.log('已添加Authorization头');
                } else {
                    console.log('未添加Authorization头，因为token不存在');
                }
                
                // 使用完整的相对路径
                const response = await fetch(`/api/companycontent/${currentEditingKey}`, requestOptions);

                if (!response.ok) {
                    throw new Error('删除内容失败');
                }

                // 隐藏编辑器，显示卡片列表
                document.getElementById('editor-section').style.display = 'none';
                document.getElementById('content-cards').style.display = 'grid';
                
                // 重新加载内容
                loadCompanyContents();
                alert('内容删除成功');
            } catch (error) {
                console.error('Error:', error);
                alert('删除内容失败');
            }
        }

        // 取消编辑
        function cancelEdit() {
            document.getElementById('editor-section').style.display = 'none';
            document.getElementById('content-cards').style.display = 'grid';
            currentEditingKey = null;
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 去除HTML标签，用于预览
        function stripHtml(html) {
            const tmp = document.createElement('DIV');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        // 检查用户角色权限
        async function checkUserRole() {
            try {
                // 获取token（使用try-catch避免潜在的存储访问错误）
                let token = null;
                try {
                    token = localStorage.getItem('token') || sessionStorage.getItem('token');
                    console.log(token);
                } catch (storageError) {
                    console.log('无法访问存储:', storageError);
                    return null;
                }
                
                if (!token) {
                    console.log('未找到登录token');
                    return null;
                }
                
                // 安全地验证token格式
                if (typeof token !== 'string') {
                    console.error('token不是字符串类型');
                    return null;
                }
                
                const tokenParts = token.split('.');
                if (tokenParts.length !== 3) {
                    console.log('token格式不正确，显示权限提示');
                    return null; // 非JWT格式，显示权限提示
                }
                
                // 尝试解析payload，但即使失败也不影响功能
                try {
                    const base64Url = tokenParts[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    // 确保长度是4的倍数
                    const paddedBase64 = base64.padEnd(base64.length + (4 - base64.length % 4) % 4, '=');
                    
                    // 解析token获取角色信息
                    const payload = JSON.parse(atob(paddedBase64));
                    
                    // 尝试多种角色声明格式
                    let roles = payload['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'] || 
                                 payload['roles'] || 
                                 payload['role'] || [];
                    
                    // 标准化角色为数组格式
                    if (!Array.isArray(roles)) {
                        roles = [roles];
                    }
                    
                    console.log('当前用户角色:', roles);
                    return roles;
                } catch (parseError) {
                    console.log('无法解析token payload，显示权限提示');
                    return null; // 解析失败，显示权限提示
                }
            } catch (error) {
                console.log('角色检查过程中发生错误:', error);
                return null;
            }
        }
        
        // 显示权限提示
        function showPermissionAlert() {
            const alertContainer = document.createElement('div');
            alertContainer.className = 'alert alert-info';
            alertContainer.innerHTML = `
                <h4>权限说明</h4>
                <p>修改公司内容需要管理员权限。系统已预设管理员账户：</p>
                <ul>
                    <li>邮箱/用户名: admin@example.com</li>
                    <li>密码: Admin@123</li>
                </ul>
                <p>请使用上述管理员账户登录以获得完整的编辑权限。</p>
            `;
            
            const mainContainer = document.querySelector('.container-fluid');
            if (mainContainer) {
                mainContainer.insertBefore(alertContainer, mainContainer.firstChild);
            }
        }
        
        // 绑定事件
        document.addEventListener('DOMContentLoaded', function() {
            // 重写公共JS中的editContentByKey函数
            window.editContentByKey = function(key) {
                editContentByKeyInternal(key);
            };
            
            initPage();
            loadCompanyContents();
            
            // 检查用户角色并显示权限提示
            const roles = checkUserRole();
            if (!roles || (Array.isArray(roles) ? !roles.includes('Admin') : roles !== 'Admin')) {
                showPermissionAlert();
            }

            // 保存内容
            document.getElementById('save-content').addEventListener('click', saveContent);
            
            // 删除内容
            document.getElementById('delete-content').addEventListener('click', deleteContent);
            
            // 取消编辑
            document.getElementById('cancel-edit').addEventListener('click', cancelEdit);
            
            // 测试API调用
            document.getElementById('test-api-button').addEventListener('click', testApiCall);
        });
    </script>
</body>
</html>